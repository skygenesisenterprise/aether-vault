name: Linux Release

on:
  push:
    tags:
      - "v*-linux"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0)"
        required: true
        default: "1.0.0"

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "20"

jobs:
  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-linux') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Print trigger information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          echo "Ref type: ${{ github.ref_type }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Actor: ${{ github.actor }}"
          echo "Is tag: ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "Ends with -linux: ${{ endsWith(github.ref, '-linux') }}"
          echo "Should run: ${{ startsWith(github.ref, 'refs/tags/') && endsWith(github.ref, '-linux') || github.event_name == 'workflow_dispatch' }}"

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Extract tag version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            PACKAGE_VERSION="${VERSION}"
            echo "Manual release version: $VERSION"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            PACKAGE_VERSION="${VERSION%-linux}"
            echo "Tag version: $VERSION"
            echo "Package version: $PACKAGE_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          # Install pnpm globally
          npm install -g pnpm

          # Install Go dependencies
          cd server && go mod download && cd ..

          # Install Node.js dependencies
          pnpm install

      - name: Build Go server for Linux
        run: |
          echo "ğŸ§ Building Go server for Linux..."
          cd server

          platforms=("linux/amd64" "linux/arm64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            output_name="aether-mailer-server"
            echo "Building for $GOOS/$GOARCH..."
            
            GOOS=$GOOS GOARCH=$GOARCH go build \
              -ldflags="-s -w -X main.version=${{ steps.version.outputs.package_version }}" \
              -o "../dist/${GOOS}-${GOARCH}-${output_name}" \
              .
          done
          cd ..

      - name: Build CLI for Linux
        run: |
          echo "ğŸ”§ Building CLI for Linux..."
          cd cli

          platforms=("linux/amd64" "linux/arm64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            # Create platform directory
            mkdir -p "../dist/${GOOS}-${GOARCH}-cli"
            
            # Build CLI
            npm run build
            
            # Copy built CLI and package.json
            cp dist/main.js "../dist/${GOOS}-${GOARCH}-cli/mailer.js"
            cp package.json "../dist/${GOOS}-${GOARCH}-cli/"
            
            # Create launcher script
            cat > "../dist/${GOOS}-${GOARCH}-cli/mailer" << 'EOF'
          #!/usr/bin/env node
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          node "$DIR/mailer.js" "$@"
          EOF
            chmod +x "../dist/${GOOS}-${GOARCH}-cli/mailer"
          done
          cd ..

      - name: Build Next.js frontend
        run: |
          echo "ğŸŒ Building Next.js frontend..."
          cd app
          pnpm build

          # Copy frontend to dist
          mkdir -p ../dist/frontend
          cp -r .next/standalone ../dist/frontend/
          cp -r .next/static ../dist/frontend/
          cp package.json ../dist/frontend/
          cd ..

      - name: Create Linux archives
        run: |
          echo "ğŸ“¦ Creating Linux archives..."

          VERSION="${{ steps.version.outputs.package_version }}"
          platforms=("linux/amd64" "linux/arm64")

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "$platform"
            
            # Create archive directory
            archive_dir="aether-mailer-${VERSION}-linux-${GOARCH}"
            mkdir -p "dist/${archive_dir}"
            
            # Copy binaries and CLI
            if [ "$GOOS" = "linux" ]; then
              cp "dist/${GOOS}-${GOARCH}-aether-mailer-server" "dist/${archive_dir}/"
              cp -r "dist/${GOOS}-${GOARCH}-cli" "dist/${archive_dir}/"
            fi
            
            # Copy frontend
            cp -r dist/frontend/* "dist/${archive_dir}/"
            
            # Copy configuration files
            cp docker-compose.yml docker-entrypoint.sh "dist/${archive_dir}/" 2>/dev/null || true
            cp -r prisma/ "dist/${archive_dir}/" 2>/dev/null || true
            
            # Create Linux-specific README
            cat > "dist/${archive_dir}/README.md" << EOF
          # Aether Mailer v${VERSION} - Linux ${GOARCH}

          ## Installation

          ### Prerequisites
          - Linux ${GOARCH} compatible system
          - Node.js >= 18.0.0
          - PostgreSQL (optional, for local development)

          ### Quick Start

          1. Extract the archive:
          ```bash
          tar -xzf aether-mailer-${VERSION}-linux-${GOARCH}.tar.gz
          cd aether-mailer-${VERSION}-linux-${GOARCH}
          ```

          2. Run the server:
          ```bash
          ./aether-mailer-server
          ```

          3. Use the CLI:
          ```bash
          ./mailer --help
          ```

          4. Access the web interface:
          Open http://localhost:3000 in your browser

          ## Components

          - **aether-mailer-server**: Go backend server
          - **mailer**: Command-line interface (TypeScript/Node.js)
          - **frontend/**: Next.js web application

          ## Service Installation

          To install as a systemd service:
          ```bash
          sudo cp scripts/aether-mailer.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable aether-mailer
          sudo systemctl start aether-mailer
          ```
          EOF

            # Create archive
            cd dist
            tar -czf "${archive_dir}.tar.gz" "${archive_dir}"
            cd ..
            
            # Clean up
            rm -rf "dist/${archive_dir}"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Aether Mailer v${{ steps.version.outputs.package_version }} - Linux
          body: |
            ## Aether Mailer v${{ steps.version.outputs.package_version }} - Linux Release

            ğŸ§ **Platform**: Linux (amd64, arm64)

            ### ğŸ“¦ Downloads
            - **Linux amd64**: \`aether-mailer-${{ steps.version.outputs.package_version }}-linux-amd64.tar.gz\`
            - **Linux arm64**: \`aether-mailer-${{ steps.version.outputs.package_version }}-linux-arm64.tar.gz\`

            ### ğŸš€ Installation

            #### Option 1: Download Binary
            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.package_version }}-linux/aether-mailer-${{ steps.version.outputs.package_version }}-linux-amd64.tar.gz
            tar -xzf aether-mailer-${{ steps.version.outputs.package_version }}-linux-amd64.tar.gz
            cd aether-mailer-${{ steps.version.outputs.package_version }}-linux-amd64

            # Run
            ./aether-mailer-server
            ```

            #### Option 2: System Package (Ubuntu/Debian)
            ```bash
            # Add repository
            echo "deb [arch=amd64,arm64] https://apt.aether-mailer.com stable main" | sudo tee /etc/apt/sources.list.d/aether-mailer.list
            wget -qO - https://apt.aether-mailer.com/public.key | sudo apt-key add -
            sudo apt update
            sudo apt install aether-mailer
            ```

            ### ğŸ“‹ Requirements

            - **OS**: Linux (Ubuntu 20.04+, Debian 11+, CentOS 8+)
            - **Architecture**: x86_64 (amd64) or ARM64 (arm64)
            - **Node.js**: >= 18.0.0
            - **Memory**: Minimum 2GB RAM
            - **Storage**: Minimum 1GB free space

            ### ğŸ› ï¸ Features

            - âœ… Multi-architecture support
            - âœ… systemd service integration
            - âœ… Automatic updates
            - âœ… Web-based administration
            - âœ… RESTful API
            - âœ… CLI management tools

            ---

            ğŸ› **Report Issues**: [GitHub Issues](https://github.com/skygenesisenterprise/aether-mailer/issues)
            ğŸ’¡ **Get Help**: [GitHub Discussions](https://github.com/skygenesisenterprise/aether-mailer/discussions)

            ğŸ“¦ **Made with â¤ï¸ by [Sky Genesis Enterprise](https://skygenesisenterprise.com)**
          draft: false
          prerelease: false
          files: |
            dist/aether-mailer-${{ steps.version.outputs.package_version }}-linux-*.tar.gz

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: linux-binaries
          path: |
            dist/aether-mailer-${{ steps.version.outputs.package_version }}-linux-*.tar.gz
          retention-days: 30
